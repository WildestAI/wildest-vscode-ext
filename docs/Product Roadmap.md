## **Implementation Roadmap: LLM-Powered DiffGraph VSCode Extension**

### **Phase 1: Foundation & CLI Integration**

1.  **Project Setup & Basic Extension:**
    * Initialize new VSCode extension project (`yo code`) with TypeScript.
    * Select `esbuild` as the bundler.
    * Set up basic `package.json` scripts (`compile`, `watch`, `test`, `lint`).
    * Verify extension compiles and activates in a test environment.

2.  **Command Registration:**
    * Register a simple VSCode command (e.g., `diffGraph.generate`) in `extension.ts`.
    * Add this command to `package.json`'s `contributes.commands`.
    * Test that the command appears in the Command Palette.

3.  **Basic Webview Panel Creation:**
    * Implement logic in the command handler to create and show a `vscode.WebviewPanel`.
    * Set a basic `title` (e.g., "DiffGraph") and `viewColumn` (e.g., `vscode.ViewColumn.Beside`).
    * Ensure the Webview shows a placeholder HTML content (e.g., `<h1>Generating DiffGraph...</h1>`).
    * Test that executing the command opens a new Webview panel.

4.  **Obtain Raw Git Diff Content (for a Changeset):**
    * **Contextual Command Strategy:**
        * Get access to the Git extension using `vscode.extensions.getExtension('vscode.git')`.
        * Once activated, access its `API` object.
        * Call methods on the Git API to get `Repository` objects.
        * **Update:** The extension should only provide the repository path to the CLI tool. The Rust CLI is responsible for all git operations and diff calculation. The extension does not calculate or pass a diff itself.
    * Log the *repository path* and CLI command to the VSCode output channel for verification.
    * **Test:** Run the command and verify the CLI is invoked with the correct environment variables and repository path.

5.  **Execute External DiffGraph CLI Tool:**
    * **Prerequisite:** Assume the `diffgraph-cli` tool is installed and accessible in the user's `PATH`.
    * Use Node.js's `child_process.exec` or `child_process.spawn` to execute the `diffgraph-cli` command.
    * Pass the repository path and output directory via environment variables (GIT_DIR, OUTPUT_PATH, LINK_URL). Do not calculate or pass a diff from the extension.
    * Specify an output path for the generated HTML file (e.g., a temporary file in the user's OS temp directory).
    * Log the CLI command being executed and any output/errors from the CLI.
    * **Test:**
        * Create a dummy `diffgraph-cli` script locally (e.g., a simple Rust or Python script that generates a basic HTML file).
        * Verify your extension successfully calls this dummy CLI and creates the HTML file.

6.  **Load Generated HTML into Webview:**
    * Read the content of the HTML file generated by the `diffgraph-cli` (from step 5) using Node.js `fs.readFile`.
    * Set the `webview.html` property of your `WebviewPanel` to this read HTML content.
    * **Important Webview Considerations:**
        * Set `webview.options.enableScripts = true` if the generated HTML has JavaScript.
        * Set `webview.options.localResourceRoots` to allow the Webview to load local CSS/JS/images if the generated HTML links to them (e.g., the directory where the HTML is generated). This is critical if the generated HTML has external assets.
    * **Test:**
        * With your dummy `diffgraph-cli` generating a simple HTML page, verify that the Webview successfully displays that HTML.
        * Verify any embedded CSS/JS in the generated HTML works (e.g., a simple button changes color).

### **Phase 2: User Experience & Refinements**

7.  **Progress Indicators & Error Handling for CLI Execution:**
    * Show a `vscode.window.withProgress` indicator while the CLI tool is running (as LLM calls can be slow).
    * Implement robust `try-catch` blocks around `child_process` execution.
    * Handle different exit codes from the `diffgraph-cli`:
        * Success: Display the HTML.
        * Error: Show `vscode.window.showErrorMessage` with details from CLI's stderr.
    * Handle cases where the `diffgraph-cli` is not found in the user's `PATH`.
    * **Test:**
        * Simulate slow CLI execution to check progress indicator.
        * Simulate CLI errors (e.g., invalid input, non-zero exit code) and verify error messages.
        * Test with CLI not found.

8.  **Contextual Command Activation & Input Flexibility:**
    * **Enhance Command Context:**
        * Add `when` clauses to your command in `package.json` to make it appear in specific contexts:
            * `scm/title` (Source Control view title menu)
            * `diff/title` (Title menu of an active diff editor)
    * **Allow User Input (Optional but useful):**
        * If applicable, add logic to prompt the user for commit IDs if the command is executed outside an active diff context (e.g., `vscode.window.showInputBox`).
        * Modify step 4 to get diff between selected commit IDs using `repository.diff(ref1, ref2)`.
    * **Test:**
        * Verify the command appears in the Source Control view's "..." menu.
        * Verify the command appears in the title bar of a standard VSCode diff view.
        * Test the commit ID input flow if implemented.

9.  **Temporary File Management:**
    * Implement logic to create temporary files (for diff input and HTML output) in a secure and clean manner (e.g., using a library like `temp-write` or Node.js `os.tmpdir()`).
    * Ensure temporary files are cleaned up after the Webview is shown or the panel is disposed.
    * **Test:** Verify temporary files are created and subsequently removed.

10. **Documentation & User Guide:**
    * Create a `README.md` for the extension:
        * Clearly state the dependency on `diffgraph-cli`.
        * Provide installation instructions for `diffgraph-cli`.
        * Explain how to use the extension (contexts, command).
        * Add screenshots.

### **Phase 3: Polish & Release Preparation**

11. **Performance Optimization:**
    * Monitor the overall latency (Git diff retrieval + CLI execution + HTML rendering).
    * For very large diffs, consider streaming input to the CLI or optimizing the CLI call if possible.

12. **Robustness and Edge Cases:**
    * Test with very large diffs.
    * Test with binary file diffs (CLI should ideally ignore/handle them gracefully).
    * Test with empty diffs.

13. **Testing and Bug Fixing:**
    * Thoroughly test all features end-to-end.
    * Address any reported bugs.

14. **Packaging and Publishing:**
    * Generate the `.vsix` package.
    * Prepare for publishing to the VSCode Marketplace (publisher setup, icon, categories, keywords).
